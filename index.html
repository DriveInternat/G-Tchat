<!--
Global Chat (single-file) — HTML / CSS / JS
Instructions:
1) Créez un projet Firebase (https://console.firebase.google.com).
2) Activez Realtime Database et mettez des règles de test pendant le développement :
   {
     "rules": {
       ".read": true,
       ".write": true
     }
   }
   *ATTENTION* : ces règles sont ouvertes. Avant production, restreignez-les (ex: auth).
3) Récupérez la configuration Firebase et remplacez l'objet `firebaseConfig` ci-dessous.
4) Déployez ce fichier sur GitHub Pages (ou tout hébergement statique).

Ce fichier fournit un chat global simple (sans authentification) utilisant Firebase Realtime Database.
-->

<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Global Chat</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#7c3aed;--muted:#94a3b8;--msg:#e6eef8}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Arial;background:linear-gradient(180deg,#071023 0%,#071731 100%);color:var(--msg);display:flex;align-items:center;justify-content:center;height:100vh}
    .app{width:100%;max-width:880px;height:90vh;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.15));border-radius:12px;padding:18px;display:grid;grid-template-rows:auto 1fr auto;gap:12px;box-shadow:0 10px 30px rgba(2,6,23,0.6)}
    header{display:flex;align-items:center;gap:12px}
    header h1{margin:0;font-size:1.1rem}
    .meta{margin-left:auto;color:var(--muted);font-size:0.9rem}
    .chat-window{background:rgba(255,255,255,0.02);border-radius:10px;padding:12px;overflow:auto;display:flex;flex-direction:column;gap:8px}
    .message{display:flex;gap:10px;align-items:flex-start}
    .avatar{width:38px;height:38px;border-radius:8px;background:linear-gradient(180deg,var(--accent),#6d28d9);display:flex;align-items:center;justify-content:center;font-weight:700;color:white}
    .bubble{background:rgba(255,255,255,0.03);padding:10px 12px;border-radius:10px;max-width:78%;line-height:1.25}
    .meta-row{display:flex;gap:8px;align-items:center;font-size:0.8rem;color:var(--muted)}
    .controls{display:flex;gap:8px;align-items:center}
    input[type=text], textarea{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 10px;border-radius:8px;color:var(--msg);outline:none}
    input[type=text]::placeholder, textarea::placeholder{color:rgba(255,255,255,0.35)}
    .send-row{display:flex;gap:8px}
    button{background:var(--accent);border:none;padding:9px 12px;border-radius:8px;color:white;cursor:pointer}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06)}
    footer{display:flex;gap:8px;align-items:center}
    @media(max-width:520px){.app{height:95vh;padding:12px}.avatar{width:34px;height:34px}}
  </style>
</head>
<body>
  <main class="app">
    <header>
      <h1>Global Chat</h1>
      <div class="meta">Messages en temps réel · Firebase Realtime DB</div>
    </header>

    <section id="messages" class="chat-window" aria-live="polite"></section>

    <div>
      <div style="display:flex;gap:8px;margin-bottom:8px;">
        <input id="nick" type="text" placeholder="Votre pseudo (ex: Alice)" style="flex:0 0 220px;" />
        <input id="filter" type="text" placeholder="Filtrer par pseudo ou texte (optionnel)" />
        <button id="clearLocal" class="ghost">Effacer messages locaux</button>
      </div>
      <div class="send-row">
        <textarea id="text" rows="2" placeholder="Écrivez un message..."></textarea>
        <div style="display:flex;flex-direction:column;gap:8px">
          <button id="send">Envoyer</button>
          <button id="scrollBottom" class="ghost">Aller en bas</button>
        </div>
      </div>
    </div>
  </main>

  <!-- Firebase compat SDK (facile à utiliser dans une page statique) -->
<!-- Firebase compat SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>

  <script>
    // ==== REMPLACEZ par votre configuration Firebase ====
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "firebase/app";
    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries

    // Your web app's Firebase configuration
    // Configuration Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyD4FuUOmGCb00GLt2gmdcayaSliaOS7DX0",
      authDomain: "g-tchat-a1d75.firebaseapp.com",
      databaseURL: "https://g-tchat-a1d75-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "g-tchat-a1d75",
      storageBucket: "g-tchat-a1d75.appspot.com",
      messagingSenderId: "248087967340",
      appId: "1:248087967340:web:602ad89b69877f9178ca49"
    };

    // Initialisation Firebase (compat)
    firebase.initializeApp(firebaseConfig);

    // Connexion anonyme
    firebase.auth().signInAnonymously()
      .then(() => console.log("Connecté anonymement ✅"))
      .catch(err => console.error("Erreur auth anonyme:", err));

    const db = firebase.database();
    const messagesRef = db.ref('messages');


    // UI éléments
    const messagesEl = document.getElementById('messages');
    const nickEl = document.getElementById('nick');
    const textEl = document.getElementById('text');
    const sendBtn = document.getElementById('send');
    const filterEl = document.getElementById('filter');
    const clearLocalBtn = document.getElementById('clearLocal');
    const scrollBottomBtn = document.getElementById('scrollBottom');

    // Lecture en temps réel : on affiche les nouveaux enfants
    messagesRef.limitToLast(200).on('child_added', snapshot => {
      const m = snapshot.val();
      appendMessage(m);
    });

    // Remplir l'historique initial (déjà couvert par child_added) mais on garde cette fonction pour le reset
    messagesRef.limitToLast(200).once('value').then(() => { /* noop */ });

    // Envoi
    sendBtn.addEventListener('click', sendMessage);
    textEl.addEventListener('keydown', e => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });

    function sendMessage(){
      const nick = (nickEl.value || 'Anon').trim().slice(0,30);
      const text = (textEl.value || '').trim().slice(0,1000);
      if(!text) return;
      const payload = {
        nick,
        text,
        ts: Date.now()
      };
      messagesRef.push(payload).then(() => {
        textEl.value = '';
      }).catch(err => {
        console.error('Erreur écriture:', err);
        alert('Impossible d\'envoyer le message. Vérifiez la configuration Firebase et les règles de la DB.');
      });
    }

    // Filtre local
    filterEl.addEventListener('input', applyFilter);
    function applyFilter(){
      const q = filterEl.value.trim().toLowerCase();
      Array.from(messagesEl.children).forEach(item => {
        const text = item.getAttribute('data-text') || '';
        const nick = item.getAttribute('data-nick') || '';
        const visible = !q || text.toLowerCase().includes(q) || nick.toLowerCase().includes(q);
        item.style.display = visible ? '' : 'none';
      });
    }

    // Ajout d'un message dans le DOM
    function appendMessage(m){
      const el = document.createElement('div');
      el.className = 'message';
      el.setAttribute('data-text', m.text || '');
      el.setAttribute('data-nick', m.nick || '');

      const avatar = document.createElement('div');
      avatar.className = 'avatar';
      avatar.textContent = (m.nick || 'A').slice(0,2).toUpperCase();

      const bubble = document.createElement('div');
      bubble.className = 'bubble';

      const metaRow = document.createElement('div');
      metaRow.className = 'meta-row';
      const nameSpan = document.createElement('strong');
      nameSpan.style.fontWeight = 700;
      nameSpan.style.color = 'white';
      nameSpan.textContent = m.nick || 'Anon';
      const timeSpan = document.createElement('span');
      timeSpan.textContent = new Date(m.ts).toLocaleString();
      metaRow.appendChild(nameSpan);
      metaRow.appendChild(timeSpan);

      const txt = document.createElement('div');
      txt.textContent = m.text || '';

      bubble.appendChild(metaRow);
      bubble.appendChild(txt);

      el.appendChild(avatar);
      el.appendChild(bubble);

      messagesEl.appendChild(el);
      // limite locale : uniquement derniers 500 éléments
      while(messagesEl.children.length > 500) messagesEl.removeChild(messagesEl.firstChild);

      // appliquer filtre courant
      applyFilter();

      // scroller automatiquement sauf si l'utilisateur a scrollé vers le haut
      const atBottom = (messagesEl.scrollTop + messagesEl.clientHeight) >= (messagesEl.scrollHeight - 80);
      if(atBottom) messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // Effacer l'affichage local (pas la DB)
    clearLocalBtn.addEventListener('click', ()=>{ messagesEl.innerHTML=''; });

    // bouton aller en bas
    scrollBottomBtn.addEventListener('click', ()=>{ messagesEl.scrollTop = messagesEl.scrollHeight; });

    // Gestion basique d'erreurs DB
    db.ref('.info/connected').on('value', snap => {
      if(!snap.val()){
        console.warn('Déconnecté de Firebase Realtime Database.');
      }
    });

    // NOTE: pour une version "production":
    // - Ajoutez une authentification (Firebase Auth, Google/GitHub/anonyme),
    // - Mettez des règles DB qui autorisent l'écriture seulement si authentifié,
    // - Ajoutez modération (préventif) ou suppression côté serveur.

  </script>
</body>
</html>
